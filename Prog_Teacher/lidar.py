import airsim
import time
import os

"""
Точки, полученные с лидара, представляют собой трехмерные координаты в пространстве,
которые формируют облако точек. Эти точки содержат информацию о расстоянии и направлении 
до объектов, находящихся вокруг дрона.

Что такое облако точек?
Облако точек — это множество точек, каждая из которых представляет координаты X, Y и Z 
в трехмерном пространстве. Эти координаты описывают поверхность объектов, 
обнаруженных лидаром в окружающей среде.

Как лидар собирает данные?
Лидар (LIDAR - Light Detection and Ranging) работает, испуская лазерные лучи и измеряя время, 
которое требуется свету, чтобы вернуться после отражения от объекта. Этот метод позволяет 
точно измерить расстояние до объектов и построить трехмерное изображение окружающей среды.

Объяснение значений точек:
X, Y, Z: Это координаты точки в трехмерной системе координат. 
Они показывают, где в пространстве находится объект относительно лидара.
    X: Горизонтальное смещение относительно дрона (влево или вправо).
    Y: Глубина или расстояние перед дроном (вперед или назад).
    Z: Вертикальное смещение (вверх или вниз).
    
Пример:
Если у вас есть точка с координатами (2.0, 3.0, -1.0), это означает:
    Объект находится на 2 метра справа от лидара.
    Объект находится на 3 метра перед лидаром.
    Объект находится на 1 метр ниже лидара.
"""

# Подключение к симулятору
client = airsim.MultirotorClient()
client.confirmConnection()

# Разблокировка управления и взлет
client.enableApiControl(True)
client.armDisarm(True)

# Взлет до высоты 3 метра
client.takeoffAsync().join()
client.moveToZAsync(-3, 1).join()

# Полет вперед на 10 метров со скоростью 5 м/с
client.moveToPositionAsync(10, 0, -3, 5).join()

# Сбор данных с лидара
lidar_data = client.getLidarData()

# Проверка наличия данных с лидара
if len(lidar_data.point_cloud) > 3:
    print("Данные лидара получены")
    # Сохранение данных лидара в файл
    lidar_points = []
    for i in range(0, len(lidar_data.point_cloud), 3):
        lidar_points.append((lidar_data.point_cloud[i],
                             lidar_data.point_cloud[i+1],
                             lidar_data.point_cloud[i+2]))

    with open("lidar_data.txt", "w") as f:
        for point in lidar_points:
            f.write(f"{point[0]} {point[1]} {point[2]}\n")
    print("Данные лидара сохранены в lidar_data.txt")
else:
    print("Данные лидара не получены")

# Приземление
client.landAsync().join()

# Отключение управления
client.armDisarm(False)
client.enableApiControl(False)

print("Полёт завершен успешно!")
